<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Converter Pro | Stable Edition</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --success: #22c55e;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: var(--bg); color: var(--text-main); }
        .container { max-width: 850px; margin: 40px auto; background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
        
        header { border-bottom: 1px solid var(--border); margin-bottom: 25px; padding-bottom: 20px; }
        header h2 { margin: 0; font-size: 24px; color: var(--primary); }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: var(--text-muted); font-size: 13px; border-bottom: 2px solid var(--border); }
        td { padding: 15px 12px; border-bottom: 1px solid var(--border); }

        .progress-container { width: 100%; background: #f1f5f9; border-radius: 5px; height: 6px; margin-top: 8px; display: none; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s ease; }

        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-size: 14px; font-weight: 500; cursor: pointer; transition: 0.2s; }
        .btn-convert { background: var(--primary); color: white; }
        .btn-download { background: var(--success); color: white; }
        .btn-stop { background: #fee2e2; color: var(--danger); }
        .btn-delete { background: transparent; color: var(--text-muted); }
        .btn-delete:hover { color: var(--danger); }
        .btn-add { background: white; border: 1px solid var(--border); margin-right: 10px; }
        .btn-all { background: var(--text-main); color: white; float: right; }

        .status-text { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
        .controls { margin-top: 25px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>MP3 Audio Converter</h2>
        <p style="font-size: 14px; color: var(--text-muted);">Ubah file audio ke MP3 128kbps langsung di browser.</p>
    </header>
    
    <table id="conversionTable">
        <thead>
            <tr>
                <th>Detail File</th>
                <th style="text-align: right;">Aksi</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div class="controls">
        <input type="file" id="bulkInput" multiple accept="audio/*" style="display: none;" onchange="handleFiles(this)">
        <button class="btn btn-add" onclick="document.getElementById('bulkInput').click()">+ Pilih File</button>
        <button id="convertAllBtn" class="btn btn-all" onclick="convertAll()" disabled>Konversi Semua</button>
    </div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    // Penting: Menggunakan logger untuk melihat apa yang error di Console (F12)
    let ffmpeg = createFFmpeg({ log: true });
    let rowCount = 0;

    async function ensureFFmpeg() {
        if (!ffmpeg.isLoaded()) {
            try {
                await ffmpeg.load();
            } catch (e) {
                console.error("FFmpeg Load Error:", e);
                alert("Gagal memuat engine konversi. Pastikan Anda menggunakan Lokal Server (Live Server).");
            }
        }
    }

    function handleFiles(input) {
        const files = Array.from(input.files);
        if(files.length > 0) document.getElementById('convertAllBtn').disabled = false;
        
        files.forEach(file => {
            rowCount++;
            const tbody = document.getElementById("tableBody");
            const row = document.createElement("tr");
            row.id = `row-${rowCount}`;
            row.fileData = file;
            row.innerHTML = `
                <td>
                    <div style="font-weight: 600;">${file.name}</div>
                    <div id="info-${rowCount}" class="status-text">Siap</div>
                    <div id="prog-cont-${rowCount}" class="progress-container"><div id="prog-${rowCount}" class="progress-bar"></div></div>
                </td>
                <td style="text-align: right;">
                    <button id="btn-conv-${rowCount}" class="btn btn-convert" onclick="process(${rowCount})">Convert</button>
                    <button id="btn-stop-${rowCount}" class="btn btn-stop" style="display:none;" onclick="stopProc(${rowCount})">Stop</button>
                    <button id="btn-del-${rowCount}" class="btn btn-delete" onclick="this.closest('tr').remove()">Hapus</button>
                </td>
            `;
            tbody.appendChild(row);
        });
        input.value = '';
    }

    async function process(id) {
        const row = document.getElementById(`row-${id}`);
        const file = row.fileData;
        const info = document.getElementById(`info-${id}`);
        const progCont = document.getElementById(`prog-cont-${id}`);
        const progBar = document.getElementById(`prog-${id}`);
        const btnConv = document.getElementById(`btn-conv-${id}`);
        const btnStop = document.getElementById(`btn-stop-${id}`);

        try {
            btnConv.style.display = 'none';
            btnStop.style.display = 'inline-block';
            progCont.style.display = 'block';
            info.innerText = "Memuat engine...";

            await ensureFFmpeg();

            ffmpeg.setProgress(({ ratio }) => {
                progBar.style.width = (ratio * 100) + "%";
                info.innerText = `Mengonversi... ${Math.floor(ratio * 100)}%`;
            });

            const timestamp = new Date().getTime();
            const outName = `converted-${file.name.replace(/\.[^/.]+$/, "")}-${timestamp}.mp3`;

            // Tulis file ke memori virtual ffmpeg
            ffmpeg.FS('writeFile', 'input_file', await fetchFile(file));
            
            // Eksekusi konversi
            await ffmpeg.run('-i', 'input_file', '-b:a', '128k', outName);

            // Baca hasil
            const data = ffmpeg.FS('readFile', outName);
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'audio/mp3' }));

            info.innerText = "Selesai!";
            btnStop.style.display = 'none';
            
            const dlBtn = document.createElement('button');
            dlBtn.className = "btn btn-download";
            dlBtn.innerText = "Download";
            dlBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = url;
                a.download = outName;
                a.click();
            };
            btnConv.parentNode.replaceChild(dlBtn, btnConv);

            // Bersihkan memori virtual
            ffmpeg.FS('unlink', 'input_file');

        } catch (e) {
            console.error(e);
            info.innerText = "Error Konversi!";
            btnConv.style.display = 'inline-block';
            btnStop.style.display = 'none';
        }
    }

    async function stopProc(id) {
        window.location.reload(); // Cara paling aman menghentikan FFmpeg.wasm adalah reload/re-init
    }

    async function convertAll() {
        const rows = document.querySelectorAll("#tableBody tr");
        for (let row of rows) {
            const id = row.id.split('-')[1];
            const btn = document.getElementById(`btn-conv-${id}`);
            if (btn && btn.style.display !== 'none') {
                await process(id);
            }
        }
    }
</script>
</body>
</html>